extends layout
block content
  div(style="width: 90%; margin-left:auto; margin-right:auto; text-align:center;").my-3
    script(type="text/javascript" src="/socket.io/socket.io.js")
    script(type='text/javascript').
      console.log("hello")
      console.log("roomId:" + #{roomId});
      var socket = io.connect();
      socket.emit("join", {roomId: "#{roomId}", username: "#{username}", userId: "#{userId}"});
      socket.on("janken_start", (data) => {
        appendMsg("対戦相手が現れました")
        socket.emit("sendDataToOpponent_s", {username: "#{username}"})
      });
      socket.on("sendDataToOpponet_c", (data) => {
        console.log("opponent data is received!" + data.opponentName);
        setOpponentName(data.opponentName);
      });
      socket.on("result", (data) => {
        var res = data.result;
        if(res == '1'){
          console.log("勝った");
          appendMsg("あなたは" + data.you + "を出し、" + "相手は"+ data.oppo を出しました)
          appendMsg("Win!")
          winIncrement();
        }else if(res == '0'){
          console.log("負けた")
          appendMsg("あなたは" + data.you + "を出し、" + "相手は"+ data.oppo を出しました)
          appendMsg("Lose!")
          loseIncrement();
        }else {
          console.log("あいこ");
          appendMsg("あなたは" + data.you + "を出し、" + "相手は"+ data.oppo を出しました)
          appendMsg("draw!")
          drawIncrement();
        }
      })
      socket.on("message_to_client", (data) => {
        //XSS脆弱性を対策する
        appendMsg(data.msg);
      })
      function appendMsg(message) {
            $("#chatLogs").append("<div>" + message + "</div>");
            $('#chatLogs').animate({scrollTop: $('#chatLogs')[0].scrollHeight}, 'fast');
        }
      $("form").submit(function(e){
        var msg = $("#msgForm").val();
        socket.emit('message_to_server', {msg: msg});
        e.preventDefault();
      }
    div
      div(style='float:left')
        h2 #{username}
        p#nextTe 次に出す手: 未設定
      div
        h2#opponentName 対戦相手は不在です
        p 相手の手: 未設定
    br
    form
      div.form-group
        label(for="msgForm") ユーザーネーム
        input(type="text" name="msgForm").form-control#msgForm
      div
        button(type="submit").btn.btn-info メッセージを送信する
    div(style="margin:0px;padding:0px;")
      div(style="margin:0px;padding:0px;line-height:1.3;")
        <div style="margin:0px;padding:10px;line-height:1.3;overflow:auto;text-align:left;height:200px;" id="chatLogs">
    div
      button#btnGu グー
      button#btnPa チョキ
      button#btnChoki パー
      p#winCounter 勝ち:0
      p#drawCounter あいこ:0
      p#loseCounter 負け:0
      
